<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Carteira de Investimentos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <div id="alertaNaoSalvo" class="alert alert-warning text-center m-0 hidden">
        ⚠️ <strong>ALTERAÇÕES PENDENTES!</strong> Salve antes de sair.
    </div>

    <nav class="navbar navbar-custom px-4 sticky-top">
        <div class="container-fluid">
            <button class="navbar-toggler bg-light me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#menuLateral">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a class="navbar-brand text-white" href="#" id="headerNomeCliente">Investimentos</a>
            <div class="d-flex gap-2 ms-auto">
                <button class="btn btn-success btn-sm fw-bold" onclick="salvarAlteracoes()"><i class="bi bi-save"></i> SALVAR</button>
                <button class="btn btn-outline-light btn-sm" onclick="voltarIndex()"><i class="bi bi-arrow-return-left"></i> Voltar</button>
            </div>
        </div>
    </nav>

    <div class="offcanvas offcanvas-start" tabindex="-1" id="menuLateral">
        <div class="offcanvas-header bg-dark text-white">
            <h5 class="offcanvas-title"><i class="bi bi-menu-button-wide"></i> Navegação</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body d-flex flex-column p-0" id="conteudoMenuLateral"></div>
    </div>

    <div class="container mt-4 mb-5 pb-5">
        
        <div class="row mb-4">
            <div class="col-md-5">
                <div class="card shadow-sm h-100 border-0 bg-primary text-white">
                    <div class="card-body d-flex flex-column justify-content-center text-center">
                        <h5 class="opacity-75">PATRIMÔNIO INVESTIDO</h5>
                        <h1 class="display-4 fw-bold" id="displayTotal">R$ 0,00</h1>
                        <hr class="border-white">
                        <div class="row text-center mt-2">
                            <div class="col-6 border-end">
                                <small>Renda Fixa</small>
                                <div class="fw-bold fs-5" id="displayFixa">R$ 0,00</div>
                            </div>
                            <div class="col-6">
                                <small>Renda Variável</small>
                                <div class="fw-bold fs-5" id="displayVariavel">R$ 0,00</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-7">
                <div class="card shadow-sm h-100 border-0">
                    <div class="card-body">
                        <h6 class="card-title text-muted border-bottom pb-2">Alocação da Carteira</h6>
                        <div style="height: 200px; display: flex; justify-content: center;">
                            <canvas id="graficoAlocacao"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="section-title my-0">Ativos na Carteira</h4>
            <button class="btn btn-dark fw-bold shadow-sm" data-bs-toggle="modal" data-bs-target="#modalInvestimento" onclick="prepararNovo()">
                <i class="bi bi-plus-circle"></i> Novo Aporte
            </button>
        </div>

        <div id="listaInvestimentos" class="row g-3"></div>

    </div>

    <div class="modal fade" id="modalInvestimento" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitulo">Gerenciar Ativo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editIndex" value="-1">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Nome do Investimento *</label>
                        <input type="text" id="invNome" class="form-control" placeholder="Ex: CDB Banco X ou Ações PETR4">
                    </div>

                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">Categoria *</label>
                            <select id="invCategoria" class="form-select">
                                <option value="Renda Fixa">Renda Fixa</option>
                                <option value="Renda Variável">Renda Variável</option>
                            </select>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">Valor Atual (R$) *</label>
                            <input type="number" id="invValor" class="form-control" placeholder="0.00">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">Aporte Mensal (R$)</label>
                            <input type="number" id="invAporte" class="form-control">
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">Rentabilidade (% a.a)</label>
                            <input type="number" id="invRentabilidade" class="form-control" step="0.01">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Objetivo Específico</label>
                        <input type="text" id="invObjetivo" class="form-control" placeholder="Ex: Aposentadoria, Troca de Carro...">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary w-100" onclick="salvarNovoInvestimento()">Salvar Investimento</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="app.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const clientId = params.get('id');
        let listaAtivos = [];
        let isDirty = false;
        let chartInstance = null;
        const modalInv = new bootstrap.Modal(document.getElementById('modalInvestimento'));

        function init() {
            if(!clientId) {
                exibirMensagem("Erro: Cliente não identificado.", "erro", () => window.location.href = 'clientes.html');
                return;
            }
            carregarDados();
            construirMenuLateral(clientId);
        }

        function carregarDados() {
            const db = getDB();
            const client = db.find(c => c.id === clientId);
            
            if (!client) {
                exibirMensagem("Cliente não encontrado!", "erro", () => window.location.href = 'clientes.html');
                return;
            }

            document.getElementById('headerNomeCliente').innerText = `Investimentos: ${client.nome}`;
            listaAtivos = client.investimentos || [];
            
            renderizarTela();
            isDirty = false;
            document.getElementById('alertaNaoSalvo').classList.add('hidden');
        }

        function renderizarTela() {
            renderizarCards();
            calcularTotaisGrafico();
        }

        function renderizarCards() {
            const container = document.getElementById('listaInvestimentos');
            container.innerHTML = '';

            if (listaAtivos.length === 0) {
                container.innerHTML = '<div class="col-12 text-center text-muted py-5"><i>Nenhum investimento cadastrado.</i></div>';
                return;
            }

            listaAtivos.forEach((ativo, index) => {
                const isFixa = ativo.categoria === 'Renda Fixa';
                const badgeClass = isFixa ? 'bg-info text-dark' : 'bg-warning text-dark';
                
                const card = document.createElement('div');
                card.className = 'col-md-6 col-lg-4';
                card.innerHTML = `
                    <div class="card shadow-sm h-100 border-0">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <span class="badge ${badgeClass}">${ativo.categoria}</span>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown"><i class="bi bi-three-dots"></i></button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="editarInvestimento(${index})">Editar</a></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="excluirInvestimento(${index})">Excluir</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title fw-bold text-dark mb-1 text-truncate" title="${ativo.nome}">${ativo.nome}</h5>
                            <p class="small text-muted mb-3"><i class="bi bi-bullseye"></i> ${ativo.objetivo || 'Sem objetivo'}</p>
                            
                            <div class="p-3 bg-light rounded text-center mb-3">
                                <small class="d-block text-secondary">Valor Atual</small>
                                <h4 class="m-0 fw-bold text-success">${formatarMoeda(ativo.valor)}</h4>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function calcularTotaisGrafico() {
            let totalFixa = 0;
            let totalVariavel = 0;

            listaAtivos.forEach(a => {
                const valor = parseFloat(a.valor) || 0;
                if(a.categoria === 'Renda Fixa') totalFixa += valor;
                else totalVariavel += valor;
            });

            const totalGeral = totalFixa + totalVariavel;

            document.getElementById('displayTotal').innerText = formatarMoeda(totalGeral);
            document.getElementById('displayFixa').innerText = formatarMoeda(totalFixa);
            document.getElementById('displayVariavel').innerText = formatarMoeda(totalVariavel);

            const ctx = document.getElementById('graficoAlocacao').getContext('2d');
            if(chartInstance) chartInstance.destroy();

            const dataValues = totalGeral === 0 ? [1] : [totalFixa, totalVariavel];
            const bgColors = totalGeral === 0 ? ['#e9ecef'] : ['#0dcaf0', '#ffc107']; 
            const labels = totalGeral === 0 ? ['Sem dados'] : ['Renda Fixa', 'Renda Variável'];

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{ data: dataValues, backgroundColor: bgColors, borderWidth: 0 }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right' } }
                }
            });
        }

        function prepararNovo() {
            document.getElementById('editIndex').value = "-1";
            document.getElementById('invNome').value = "";
            document.getElementById('invValor').value = "";
            document.getElementById('invCategoria').value = "Renda Fixa";
            document.getElementById('modalTitulo').innerText = "Novo Aporte";
        }

        function salvarNovoInvestimento() {
            const indexVal = document.getElementById('editIndex').value;
            const index = indexVal === "" ? -1 : parseInt(indexVal);

            // --- TRAVA DE LIMITE (Só aplica se for NOVO aporte) ---
            if (index === -1) {
                // Passamos a quantidade atual para validar
                if (!verificarLimites('investimentos', listaAtivos.length)) {
                    modalInv.hide();
                    return;
                }
            }
            // -----------------------------------------------------

            const nome = document.getElementById('invNome').value;
            const valor = parseFloat(document.getElementById('invValor').value);

            if (!nome || isNaN(valor)) {
                exibirMensagem("Nome e Valor Atual são obrigatórios!", "aviso");
                return;
            }

            const novoAtivo = {
                nome: nome,
                categoria: document.getElementById('invCategoria').value,
                valor: valor,
                aporte: parseFloat(document.getElementById('invAporte').value) || 0,
                rentabilidade: parseFloat(document.getElementById('invRentabilidade').value) || 0,
                objetivo: document.getElementById('invObjetivo').value
            };

            if (index === -1) {
                listaAtivos.push(novoAtivo);
            } else {
                listaAtivos[index] = novoAtivo;
            }

            marcarComoSujo();
            renderizarTela();
            modalInv.hide();
        }

        function editarInvestimento(index) {
            const ativo = listaAtivos[index];
            document.getElementById('editIndex').value = index;
            document.getElementById('invNome').value = ativo.nome;
            document.getElementById('invValor').value = ativo.valor;
            document.getElementById('invAporte').value = ativo.aporte;
            document.getElementById('invRentabilidade').value = ativo.rentabilidade;
            document.getElementById('invObjetivo').value = ativo.objetivo;
            document.getElementById('invCategoria').value = ativo.categoria;
            document.getElementById('modalTitulo').innerText = "Editar Ativo";
            modalInv.show();
        }

        function excluirInvestimento(index) {
            exibirConfirmacao("Remover este investimento?", () => {
                listaAtivos.splice(index, 1);
                marcarComoSujo();
                renderizarTela();
            });
        }

        function marcarComoSujo() {
            isDirty = true;
            document.getElementById('alertaNaoSalvo').classList.remove('hidden');
        }

        function salvarAlteracoes(silencioso = false) {
            const db = getDB();
            const idx = db.findIndex(c => c.id === clientId);
            
            if (idx !== -1) {
                db[idx].investimentos = listaAtivos;
                saveDB(db);
                isDirty = false;
                document.getElementById('alertaNaoSalvo').classList.add('hidden');
                if (!silencioso) exibirMensagem("Dados salvos com sucesso!", "sucesso");
            }
        }

        function voltarIndex() { navegarPara('clientes.html'); }

        init();
    </script>
</body>
</html>