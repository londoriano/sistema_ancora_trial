<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Proteção Patrimonial</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</head>
<body>

    <div id="alertaNaoSalvo" class="alert alert-warning text-center m-0 hidden">
        ⚠️ <strong>ALTERAÇÕES PENDENTES!</strong> Salve antes de sair.
    </div>

    <nav class="navbar navbar-custom px-4 sticky-top">
        <div class="container-fluid">
            <button class="navbar-toggler bg-light me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#menuLateral">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a class="navbar-brand text-white" href="#" id="headerNomeCliente">Proteção</a>
            <div class="d-flex gap-2 ms-auto">
                <button class="btn btn-success btn-sm fw-bold" onclick="salvarAlteracoes()"><i class="bi bi-save"></i> SALVAR</button>
                <button class="btn btn-outline-light btn-sm" onclick="voltarIndex()"><i class="bi bi-arrow-return-left"></i> Voltar</button>
            </div>
        </div>
    </nav>

    <div class="offcanvas offcanvas-start" tabindex="-1" id="menuLateral">
        <div class="offcanvas-header bg-dark text-white">
            <h5 class="offcanvas-title"><i class="bi bi-menu-button-wide"></i> Navegação</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body d-flex flex-column p-0" id="conteudoMenuLateral"></div>
    </div>

    <div class="container mt-4 mb-5 pb-5">
        
        <div class="row align-items-center mb-4">
            <div class="col-md-8">
                <h4 class="section-title mt-0">Blindagem Patrimonial</h4>
                <p class="text-muted small">Mapeamento de riscos e apólices vigentes.</p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-primary shadow-sm" data-bs-toggle="modal" data-bs-target="#modalSeguro" onclick="prepararNovo()">
                    <i class="bi bi-shield-plus"></i> Adicionar Cobertura
                </button>
            </div>
        </div>

        <div class="card shadow-sm border-0 mb-4">
            <div class="card-body p-0">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Cobertura / Risco</th>
                            <th>Descrição / Seguradora</th>
                            <th>Valor Cobertura</th>
                            <th class="text-end">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="listaSeguros">
                        </tbody>
                </table>
            </div>
        </div>

        <h5 class="fw-bold text-secondary">Observações & Análise de Risco</h5>
        <textarea id="obsProtecao" class="form-control shadow-sm" rows="4" placeholder="Análise sobre a exposição ao risco do cliente..."></textarea>

    </div>

    <div class="modal fade" id="modalSeguro" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitulo">Nova Cobertura</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editIndex" value="-1">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Tipo de Cobertura *</label>
                        <select id="segTipo" class="form-select">
                            <option value="Morte Natural ou Acidental">Morte Natural ou Acidental</option>
                            <option value="Invalidez Permanente (Acidente)">Invalidez Permanente (Acidente)</option>
                            <option value="Invalidez Funcional (Doença - IFPD)">Invalidez Funcional (Doença - IFPD)</option>
                            <option value="Doenças Graves (DG)">Doenças Graves (DG)</option>
                            <option value="Diária Incapacidade (DIT)">Diária Incapacidade Temporária (DIT)</option>
                            <option value="Despesas Médicas (DMHO)">Despesas Médicas (DMHO)</option>
                            <option value="Auxílio Funeral">Auxílio Funeral</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Descrição / Seguradora</label>
                        <input type="text" id="segDesc" class="form-control" placeholder="Ex: Prudential Apólice 123">
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold text-success">Capital Segurado (Valor) *</label>
                        <input type="number" id="segValor" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarSeguroMemoria()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="app.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const clientId = params.get('id');
        let currentClient = null;
        let listaSeguros = [];
        let isDirty = false;
        const modal = new bootstrap.Modal(document.getElementById('modalSeguro'));

        function init() {
            if(!clientId) return window.location.href = 'clientes.html';
            carregarDados();
            construirMenuLateral(clientId);
        }

        function carregarDados() {
            const db = getDB();
            currentClient = db.find(c => c.id === clientId);
            if (!currentClient) return;

            document.getElementById('headerNomeCliente').innerText = `Proteção: ${currentClient.nome}`;
            
            const prot = currentClient.protecao || {};
            listaSeguros = prot.itens || [];
            document.getElementById('obsProtecao').value = prot.observacoes || '';

            renderizarTabela();
            // ADICIONE ESTA LINHA NO FINAL:
    isDirty = false;
document.getElementById('alertaNaoSalvo').classList.add('hidden');
        }

        function renderizarTabela() {
            const tbody = document.getElementById('listaSeguros');
            tbody.innerHTML = '';

            if(listaSeguros.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">Nenhuma cobertura cadastrada.</td></tr>';
                return;
            }

            listaSeguros.forEach((s, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="fw-bold text-secondary">${s.tipo}</td>
                    <td>${s.descricao}</td>
                    <td class="fw-bold">${formatarMoeda(s.valor)}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editarSeguro(${index})"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="excluirSeguro(${index})"><i class="bi bi-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function prepararNovo() {
            document.getElementById('editIndex').value = "-1";
            document.getElementById('segTipo').value = "Morte Natural ou Acidental";
            document.getElementById('segDesc').value = "";
            document.getElementById('segValor').value = "";
            document.getElementById('modalTitulo').innerText = "Nova Cobertura";
        }

        function salvarSeguroMemoria() {
    const idx = parseInt(document.getElementById('editIndex').value);
    const item = {
        tipo: document.getElementById('segTipo').value,
        descricao: document.getElementById('segDesc').value,
        valor: document.getElementById('segValor').value
    };

    if(!item.valor) {
        exibirMensagem("Insira o valor da cobertura.", "aviso");
        return;
    }

    if(idx === -1) listaSeguros.push(item);
    else listaSeguros[idx] = item;

    modal.hide();
    marcarComoSujo();
    renderizarTabela();
}

        function editarSeguro(index) {
            const s = listaSeguros[index];
            document.getElementById('editIndex').value = index;
            document.getElementById('segTipo').value = s.tipo;
            document.getElementById('segDesc').value = s.descricao;
            document.getElementById('segValor').value = s.valor;
            document.getElementById('modalTitulo').innerText = "Editar Cobertura";
            modal.show();
        }

        function excluirSeguro(index) {
    exibirConfirmacao("Excluir esta cobertura da lista de proteção?", () => {
        listaSeguros.splice(index, 1);
        marcarComoSujo();
        renderizarTabela();
    });
}

        function marcarComoSujo() {
            isDirty = true;
            document.getElementById('alertaNaoSalvo').classList.remove('hidden');
        }

        // Monitorar obs
        document.getElementById('obsProtecao').addEventListener('input', marcarComoSujo);

        // Adicione o parâmetro (silencioso = false)
function salvarAlteracoes(silencioso = false) {
    const db = getDB();
    const idx = db.findIndex(c => c.id === clientId);
    
    if (idx !== -1) {
        // CORREÇÃO:
        db[idx].protecao = {
            itens: listaSeguros,
            observacoes: document.getElementById('obsProtecao').value
        };
        
        saveDB(db);
        isDirty = false;
        document.getElementById('alertaNaoSalvo').classList.add('hidden');

        if (!silencioso) {
            exibirMensagem("Proteção Patrimonial salva com sucesso!", "sucesso");
        }
    }
}

        function voltarIndex() {
    navegarPara('clientes.html');
}

        init();
    </script>
</body>
</html>