<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Meus Objetivos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .card-objetivo { transition: transform 0.2s; border-left: 5px solid #0d6efd; }
        .card-objetivo:hover { transform: translateY(-3px); }
        .bg-concluido { border-left-color: #198754 !important; background-color: #f8f9fa; opacity: 0.8; }
        .progress-height { height: 10px; border-radius: 5px; }
    </style>
</head>
<body>

    <div id="alertaNaoSalvo" class="alert alert-warning text-center m-0 hidden">
        ‚ö†Ô∏è <strong>ALTERA√á√ïES PENDENTES!</strong> Salve antes de sair.
    </div>

    <nav class="navbar navbar-custom px-4 sticky-top">
        <div class="container-fluid">
            <button class="navbar-toggler bg-light me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#menuLateral">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a class="navbar-brand text-white" href="#" id="headerNomeCliente">Objetivos</a>
            <div class="d-flex gap-2 ms-auto">
                <button class="btn btn-success btn-sm fw-bold" onclick="salvarAlteracoes()"><i class="bi bi-save"></i> SALVAR</button>
                <button class="btn btn-outline-light btn-sm" onclick="voltarIndex()"><i class="bi bi-arrow-return-left"></i> Voltar</button>
            </div>
        </div>
    </nav>

    <div class="offcanvas offcanvas-start" tabindex="-1" id="menuLateral">
        <div class="offcanvas-header bg-dark text-white">
            <h5 class="offcanvas-title"><i class="bi bi-menu-button-wide"></i> Navega√ß√£o</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body d-flex flex-column p-0" id="conteudoMenuLateral"></div>
    </div>

    <div class="container mt-4 mb-5 pb-5">
        
        <div class="row mb-4 align-items-end">
            <div class="col-md-8">
                <h4 class="section-title my-0">Mapa de Sonhos & Metas</h4>
                <small class="text-muted">Planejamento de curto, m√©dio e longo prazo.</small>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-primary fw-bold shadow-sm" data-bs-toggle="modal" data-bs-target="#modalObjetivo" onclick="prepararNovo()">
                    <i class="bi bi-plus-circle"></i> Novo Objetivo
                </button>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card shadow-sm border-0 bg-light">
                    <div class="card-body d-flex justify-content-around text-center">
                        <div>
                            <h2 class="fw-bold text-primary mb-0" id="totalNecessario">R$ 0,00</h2>
                            <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Custo Total dos Sonhos</small>
                        </div>
                        <div class="border-start ps-4">
                            <h2 class="fw-bold text-success mb-0" id="totalGuardado">R$ 0,00</h2>
                            <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">J√° Conquistado</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="listaObjetivos" class="row g-3"></div>

    </div>

    <div class="modal fade" id="modalObjetivo" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitulo">Definir Meta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editIndex" value="-1">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">T√≠tulo do Objetivo *</label>
                        <input type="text" id="objTitulo" class="form-control" placeholder="Ex: Viagem Disney, Casa Pr√≥pria...">
                    </div>

                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">Prazo (Anos)</label>
                            <select id="objPrazo" class="form-select">
                                <option value="Curto">Curto (at√© 1 ano)</option>
                                <option value="M√©dio">M√©dio (2 a 5 anos)</option>
                                <option value="Longo">Longo (5+ anos)</option>
                                <option value="Aposentadoria">Aposentadoria</option>
                            </select>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">Prioridade</label>
                            <select id="objPrioridade" class="form-select">
                                <option value="Alta">Alta</option>
                                <option value="M√©dia">M√©dia</option>
                                <option value="Baixa">Baixa</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label fw-bold text-primary">Valor Total (R$) *</label>
                            <input type="number" id="objValorTotal" class="form-control" placeholder="0.00">
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label text-success">J√° Possui (R$)</label>
                            <input type="number" id="objValorAtual" class="form-control" placeholder="0.00">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Descri√ß√£o / Estrat√©gia</label>
                        <textarea id="objDesc" class="form-control" rows="2" placeholder="Detalhes de como atingir..."></textarea>
                    </div>

                    <div class="form-check form-switch bg-light p-2 rounded">
                        <input class="form-check-input ms-0 me-2" type="checkbox" id="objConcluido">
                        <label class="form-check-label fw-bold" for="objConcluido">Marcar como Realizado üéâ</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary w-100" onclick="salvarNovoObjetivo()">Salvar Meta</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="app.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const clientId = params.get('id');
        let listaObjetivos = [];
        let isDirty = false;
        const modalObj = new bootstrap.Modal(document.getElementById('modalObjetivo'));

        function init() {
            if(!clientId) {
                exibirMensagem("Erro: Cliente n√£o identificado.", "erro", () => window.location.href = 'clientes.html');
                return;
            }
            carregarDados();
            construirMenuLateral(clientId);
        }

        function carregarDados() {
            const db = getDB();
            const client = db.find(c => c.id === clientId);
            
            if (!client) {
                exibirMensagem("Cliente n√£o encontrado!", "erro", () => window.location.href = 'clientes.html');
                return;
            }

            document.getElementById('headerNomeCliente').innerText = `Objetivos: ${client.nome}`;
            
            // Usa array detalhado, se n√£o existir, tenta migrar do simples ou inicia vazio
            if (client.objetivosDetalhados) {
                listaObjetivos = client.objetivosDetalhados;
            } else if (client.dadosPessoais && client.dadosPessoais.listas && client.dadosPessoais.listas.objetivos) {
                // Migra√ß√£o simples
                listaObjetivos = client.dadosPessoais.listas.objetivos.map(o => ({
                    titulo: o.col1,
                    valorTotal: parseFloat(o.valor) || 0,
                    valorAtual: 0,
                    prazo: o.col3 || 'M√©dio',
                    prioridade: 'M√©dia',
                    descricao: '',
                    concluido: false
                }));
            } else {
                listaObjetivos = [];
            }
            
            renderizarTela();
            isDirty = false;
            document.getElementById('alertaNaoSalvo').classList.add('hidden');
        }

        function renderizarTela() {
            const container = document.getElementById('listaObjetivos');
            container.innerHTML = '';
            
            let somaTotal = 0;
            let somaGuardado = 0;

            if (listaObjetivos.length === 0) {
                container.innerHTML = '<div class="col-12 text-center text-muted py-5"><i>Nenhum objetivo detalhado cadastrado.</i></div>';
            } else {
                listaObjetivos.forEach((obj, index) => {
                    const isConcluido = obj.concluido === true;
                    if (!isConcluido) {
                        somaTotal += parseFloat(obj.valorTotal || 0);
                        somaGuardado += parseFloat(obj.valorAtual || 0);
                    }

                    const porcentagem = (obj.valorTotal > 0) ? Math.min(100, (obj.valorAtual / obj.valorTotal) * 100).toFixed(0) : 0;
                    
                    let corBarra = 'bg-primary';
                    if (porcentagem >= 100) corBarra = 'bg-success';
                    else if (porcentagem < 25) corBarra = 'bg-danger';
                    else if (porcentagem < 75) corBarra = 'bg-warning';

                    const card = document.createElement('div');
                    card.className = 'col-md-6 col-lg-4';
                    card.innerHTML = `
                        <div class="card shadow-sm h-100 card-objetivo ${isConcluido ? 'bg-concluido' : ''}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <h5 class="fw-bold mb-0 text-dark">${obj.titulo}</h5>
                                        <div class="d-flex gap-2 mt-1">
                                            <span class="badge bg-light text-dark border">${obj.prazo}</span>
                                            <span class="badge bg-light text-secondary border">${obj.prioridade}</span>
                                        </div>
                                    </div>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown"><i class="bi bi-three-dots"></i></button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="editarObjetivo(${index})">Editar</a></li>
                                            <li><a class="dropdown-item text-danger" href="#" onclick="excluirObjetivo(${index})">Excluir</a></li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <p class="small text-muted mb-3 text-truncate">${obj.descricao || 'Sem descri√ß√£o.'}</p>

                                <div class="d-flex justify-content-between align-items-end mb-1">
                                    <small class="text-muted">Progresso (${porcentagem}%)</small>
                                    <div class="text-end">
                                        <small class="d-block text-muted" style="font-size: 0.7rem;">Meta</small>
                                        <span class="fw-bold text-dark">${formatarMoeda(obj.valorTotal)}</span>
                                    </div>
                                </div>
                                
                                <div class="progress progress-height mb-2 bg-secondary bg-opacity-10">
                                    <div class="progress-bar ${corBarra}" role="progressbar" style="width: ${porcentagem}%"></div>
                                </div>
                                
                                <div class="small text-muted">
                                    Faltam: <strong>${formatarMoeda(Math.max(0, obj.valorTotal - obj.valorAtual))}</strong>
                                </div>

                                ${isConcluido ? '<div class="mt-2 text-center text-success fw-bold small"><i class="bi bi-trophy-fill"></i> CONQUISTADO!</div>' : ''}
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }

            document.getElementById('totalNecessario').innerText = formatarMoeda(somaTotal);
            document.getElementById('totalGuardado').innerText = formatarMoeda(somaGuardado);
        }

        function prepararNovo() {
            document.getElementById('editIndex').value = "-1";
            document.getElementById('objTitulo').value = "";
            document.getElementById('objValorTotal').value = "";
            document.getElementById('objValorAtual').value = "";
            document.getElementById('objDesc').value = "";
            document.getElementById('objPrazo').value = "M√©dio";
            document.getElementById('objPrioridade').value = "Alta";
            document.getElementById('objConcluido').checked = false;
            document.getElementById('modalTitulo').innerText = "Definir Meta";
        }

        function salvarNovoObjetivo() {
            const indexVal = document.getElementById('editIndex').value;
            const index = indexVal === "" ? -1 : parseInt(indexVal);

            // --- TRAVA DE LIMITE (2 OBJETIVOS) ---
            if (index === -1) {
                // Passamos a quantidade atual para validar
                if (!verificarLimites('objetivos', listaObjetivos.length)) {
                    modalObj.hide();
                    return;
                }
            }
            // -------------------------------------

            const titulo = document.getElementById('objTitulo').value;
            const valorTotal = parseFloat(document.getElementById('objValorTotal').value);

            if (!titulo || isNaN(valorTotal)) {
                exibirMensagem("T√≠tulo e Valor Total s√£o obrigat√≥rios!", "aviso");
                return;
            }

            const dados = {
                titulo: titulo,
                valorTotal: valorTotal,
                valorAtual: parseFloat(document.getElementById('objValorAtual').value) || 0,
                prazo: document.getElementById('objPrazo').value,
                prioridade: document.getElementById('objPrioridade').value,
                descricao: document.getElementById('objDesc').value,
                concluido: document.getElementById('objConcluido').checked
            };

            if (index === -1) {
                listaObjetivos.push(dados);
            } else {
                listaObjetivos[index] = dados;
            }

            marcarComoSujo();
            renderizarTela();
            modalObj.hide();
        }

        function editarObjetivo(index) {
            const obj = listaObjetivos[index];
            document.getElementById('editIndex').value = index;
            document.getElementById('objTitulo').value = obj.titulo;
            document.getElementById('objValorTotal').value = obj.valorTotal;
            document.getElementById('objValorAtual').value = obj.valorAtual;
            document.getElementById('objDesc').value = obj.descricao;
            document.getElementById('objPrazo').value = obj.prazo;
            document.getElementById('objPrioridade').value = obj.prioridade;
            document.getElementById('objConcluido').checked = obj.concluido || false;
            
            document.getElementById('modalTitulo').innerText = "Editar Meta";
            modalObj.show();
        }

        function excluirObjetivo(index) {
            exibirConfirmacao("Excluir este objetivo?", () => {
                listaObjetivos.splice(index, 1);
                marcarComoSujo();
                renderizarTela();
            });
        }

        function marcarComoSujo() {
            isDirty = true;
            document.getElementById('alertaNaoSalvo').classList.remove('hidden');
        }

        function salvarAlteracoes(silencioso = false) {
            const db = getDB();
            const idx = db.findIndex(c => c.id === clientId);
            
            if (idx !== -1) {
                db[idx].objetivosDetalhados = listaObjetivos;
                saveDB(db);
                isDirty = false;
                document.getElementById('alertaNaoSalvo').classList.add('hidden');
                if (!silencioso) exibirMensagem("Objetivos salvos com sucesso!", "sucesso");
            }
        }

        function voltarIndex() { navegarPara('clientes.html'); }

        init();
    </script>
</body>
</html>