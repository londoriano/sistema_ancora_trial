<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Reserva de Emergência</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</head>
<body>

    <div id="alertaNaoSalvo" class="alert alert-warning text-center m-0 hidden">
        ⚠️ <strong>ALTERAÇÕES PENDENTES!</strong> Salve antes de sair.
    </div>

    <nav class="navbar navbar-custom px-4 sticky-top">
        <div class="container-fluid">
            <button class="navbar-toggler bg-light me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#menuLateral">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a class="navbar-brand text-white" href="#" id="headerNomeCliente">Reserva</a>
            <div class="d-flex gap-2 ms-auto">
                <button class="btn btn-success btn-sm fw-bold" onclick="salvarAlteracoes()"><i class="bi bi-save"></i> SALVAR</button>
                <button class="btn btn-outline-light btn-sm" onclick="voltarIndex()"><i class="bi bi-arrow-return-left"></i> Voltar</button>
            </div>
        </div>
    </nav>

    <div class="offcanvas offcanvas-start" tabindex="-1" id="menuLateral">
        <div class="offcanvas-header bg-dark text-white">
            <h5 class="offcanvas-title"><i class="bi bi-menu-button-wide"></i> Navegação</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body d-flex flex-column p-0" id="conteudoMenuLateral"></div>
    </div>

    <div class="container mt-4 mb-5 pb-5">
        <h4 class="section-title mt-0">Calculadora de Segurança</h4>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body">
                        <form id="formReserva" onchange="calcularReserva()">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Custo de Vida Mensal (R$)</label>
                                <input type="number" id="custoVida" class="form-control" placeholder="Quanto custa o mês?">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Já possui guardado? (R$)</label>
                                <input type="number" id="valorAtual" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-success fw-bold">Aporte Mensal (R$)</label>
                                <input type="number" id="aporteMensal" class="form-control" placeholder="Quanto vai guardar?">
                            </div>
                            <div class="row">
                                <div class="col-6 mb-3">
                                    <label class="form-label small">Rentab. Anual (%)</label>
                                    <input type="number" id="rentAnual" class="form-control" value="10" step="0.1">
                                </div>
                                <div class="col-6 mb-3">
                                    <label class="form-label small">Imposto (%)</label>
                                    <input type="number" id="imposto" class="form-control" value="17.5" step="0.1">
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card bg-primary text-white border-0 shadow-sm h-100">
                    <div class="card-body d-flex flex-column justify-content-center text-center p-4">
                        <h6 class="opacity-75">META IDEAL (6 MESES)</h6>
                        <h2 class="fw-bold mb-4" id="resMetaIdeal">R$ 0,00</h2>
                        
                        <div class="bg-white text-dark rounded p-3 mb-3">
                            <small class="text-muted d-block">Tempo Necessário</small>
                            <h1 class="fw-bold m-0 text-primary" id="resTempo">- meses</h1>
                        </div>

                        <div class="d-flex justify-content-between small px-3">
                            <span>Progresso Atual:</span>
                            <span id="resProgresso">0%</span>
                        </div>
                        <div class="progress mt-1" style="height: 6px;">
                            <div class="progress-bar bg-warning" id="barProgresso" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="app.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const clientId = params.get('id');
        let currentClient = null;
        let isDirty = false;

        function init() {
            if(!clientId) return window.location.href = 'clientes.html';
            carregarDados();
            construirMenuLateral(clientId);
        }

        function carregarDados() {
            const db = getDB();
            currentClient = db.find(c => c.id === clientId);
            if (!currentClient) return;

            document.getElementById('headerNomeCliente').innerText = `Reserva: ${currentClient.nome}`;
            
            const res = currentClient.reservaEmergencia || {};
            
            // Tenta puxar custo de vida do Planejamento se não tiver salvo
            let custoSugerido = res.custoVida;
            if(!custoSugerido && currentClient.planejamento?.meta) {
                // Estima custo fixo + estilo de vida
                const renda = parseFloat(currentClient.dadosPessoais?.rendaMensal || 0);
                const pctGasto = (currentClient.planejamento.meta.essencialPct + currentClient.planejamento.meta.estiloPct) / 100;
                custoSugerido = renda * pctGasto;
            }

            document.getElementById('custoVida').value = custoSugerido || '';
            document.getElementById('valorAtual').value = res.valorAtual || '';
            document.getElementById('aporteMensal').value = res.aporteMensal || '';
            document.getElementById('rentAnual').value = res.rentAnual || '10';
            document.getElementById('imposto').value = res.imposto || '17.5';

            calcularReserva();

            // ADICIONE ESTA LINHA NO FINAL DA FUNÇÃO:
    isDirty = false; 
    document.getElementById('alertaNaoSalvo').classList.add('hidden');
        }

        function calcularReserva() {
            const custo = parseFloat(document.getElementById('custoVida').value) || 0;
            const atual = parseFloat(document.getElementById('valorAtual').value) || 0;
            const aporte = parseFloat(document.getElementById('aporteMensal').value) || 0;
            const rentAnual = parseFloat(document.getElementById('rentAnual').value) || 0;
            const imposto = parseFloat(document.getElementById('imposto').value) || 0;

            if(custo === 0) return;

            // 1. Meta (6 meses)
            const meta = custo * 6;
            document.getElementById('resMetaIdeal').innerText = formatarMoeda(meta);

            // 2. Progresso
            const pct = Math.min((atual / meta) * 100, 100);
            document.getElementById('resProgresso').innerText = pct.toFixed(1) + "%";
            document.getElementById('barProgresso').style.width = pct + "%";

            // 3. Tempo (NPER)
            if(atual >= meta) {
                document.getElementById('resTempo').innerText = "CONQUISTADA!";
                return;
            }
            if(aporte <= 0) {
                document.getElementById('resTempo').innerText = "Infinito (sem aporte)";
                return;
            }

            // Taxa mensal líquida
            const i = ((rentAnual / 100) * (1 - (imposto/100))) / 12;
            
            // Fórmula NPER: ln((FV * i + PMT) / (PV * i + PMT)) / ln(1 + i)
            // FV = Meta, PV = Atual, PMT = Aporte
            // Adaptando para meta de acumulação:
            // Valor Futuro Desejado = Meta
            
            let meses = 0;
            if(i === 0) {
                meses = (meta - atual) / aporte;
            } else {
                meses = Math.log((meta * i + aporte) / (atual * i + aporte)) / Math.log(1 + i);
            }

            document.getElementById('resTempo').innerText = Math.ceil(meses) + " meses";
            marcarComoSujo();
        }

        function marcarComoSujo() {
            isDirty = true;
            document.getElementById('alertaNaoSalvo').classList.remove('hidden');
        }

        // Adicione o parâmetro (silencioso = false)
function salvarAlteracoes(silencioso = false) {
    const db = getDB();
    const idx = db.findIndex(c => c.id === clientId);
    
    if (idx !== -1) {
        // CORREÇÃO: Capturando os dados do formulário
        db[idx].reservaEmergencia = {
            custoVida: document.getElementById('custoVida').value,
            valorAtual: document.getElementById('valorAtual').value,
            aporteMensal: document.getElementById('aporteMensal').value,
            rentAnual: document.getElementById('rentAnual').value,
            imposto: document.getElementById('imposto').value
        };
        
        saveDB(db);
        isDirty = false;
        document.getElementById('alertaNaoSalvo').classList.add('hidden');

        if (!silencioso) {
            exibirMensagem("Reserva de Emergência salva com sucesso!", "sucesso");
        }
    }
}

        function voltarIndex() {
    navegarPara('clientes.html');
}

        init();
    </script>
</body>
</html>